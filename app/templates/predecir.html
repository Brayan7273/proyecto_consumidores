{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Clasificación de Consumidores</h2>

    <form method="POST" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="archivo" class="form-label">Carga tu archivo de datos (CSV o Excel)</label>
            <input class="form-control" type="file" id="archivo" name="archivo" required>
        </div>
        <div class="mb-3">
            <label for="modelo" class="form-label">Selecciona un modelo entrenado</label>
            <select class="form-select" id="modelo" name="modelo" required>
                <option value="">-- Seleccionar --</option>
                {% for m in modelos %}
                <option value="{{ m }}">{{ m }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Predecir</button>
    </form>

    {% if resultados %}
    <hr>
    <h4>Resultados</h4>
    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    {% for col in resultados[0].keys() %}
                    <th>{{ col }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in resultados %}
                <tr>
                    {% for col in row.values() %}
                    <td>{{ col }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if estadisticas %}
    <hr>
    <h4>Estadísticas</h4>
    <div class="row" id="estadisticas">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">Resumen</div>
                <div class="card-body">
                    <p><strong>Total de registros:</strong> {{ estadisticas.conteo }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">Promedios por Pregunta</div>
                <div class="card-body">
                    <ul class="list-group">
                        {% for p, val in estadisticas.promedios.items() %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ p }}
                            <span class="badge bg-primary rounded-pill">{{ val }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if chart_data %}
    <hr>
    <h4>Visualizaciones</h4>
    <div class="row" id="graficas">
        <div class="col-md-6">
            <h5>Distribución de Tipos de Consumidor</h5>
            <canvas id="chartConteo"></canvas>
        </div>
        <div class="col-md-6">
            <h5>Promedios por Pregunta</h5>
            <canvas id="chartPromedios"></canvas>
        </div>
    </div>
    {% endif %}
</div>

{% if chart_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const data = {{ chart_data | safe }};

    // Gráfica de distribución de tipos
    const ctxConteo = document.getElementById('chartConteo').getContext('2d');
    new Chart(ctxConteo, {
        type: 'pie',
        data: {
            labels: Object.keys(data.conteo_tipos),
            datasets: [{
                data: Object.values(data.conteo_tipos),
                backgroundColor: ['rgba(255,99,132,0.6)', 'rgba(54,162,235,0.6)', 'rgba(255,206,86,0.6)']
            }]
        }
    });

    // Gráfica de promedios por pregunta
    const primerosTipos = Object.keys(data.promedios_por_tipo);
    if (primerosTipos.length > 0) {
        const preguntas = Object.keys(data.promedios_por_tipo[primerosTipos[0]]);

        const datasets = primerosTipos.map((tipo, i) => ({
            label: tipo,
            data: Object.values(data.promedios_por_tipo[tipo]),
            borderColor: `rgba(${75 + i*50}, 192, 192, 0.8)`,
            fill: false,
            tension: 0.1
        }));

        const ctxPromedios = document.getElementById('chartPromedios').getContext('2d');
        new Chart(ctxPromedios, {
            type: 'line',
            data: {
                labels: preguntas,
                datasets: datasets
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, max: 5 }
                }
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}
