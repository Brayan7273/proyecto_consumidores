{% extends "base.html" %}
{% block content %}

<h2>Análisis de Tipos de Consumidores</h2>

<form action="{{ url_for('analisis_consumidores') }}" method="POST" enctype="multipart/form-data" id="formCarga">
    <div class="mb-3">
        <label for="archivo" class="form-label">Subir dataset (CSV o Excel)</label>
        <input class="form-control" type="file" id="archivo" name="archivo" required>
    </div>
    <button type="submit" class="btn btn-primary">Cargar</button>
</form>

{% if tipos_disponibles %}
<hr>
<form id="formFiltros">
    <div class="mb-3">
        <label>Selecciona entre 2 y 4 tipos de consumidor</label>
        <div id="checkboxTipos" class="d-flex flex-wrap gap-3">
            {% for tipo in tipos_disponibles %}
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="tipos_seleccionados" value="{{ tipo }}" id="chk_{{ loop.index }}">
                <label class="form-check-label" for="chk_{{ loop.index }}">{{ tipo }}</label>
            </div>
            {% endfor %}
        </div>
        <div id="errorSeleccion" class="text-danger mt-1" style="display:none;">Selecciona mínimo 2 y máximo 4 tipos.</div>
    </div>

    <!-- Aquí aparecerán las preguntas asociadas -->
    <div id="preguntas_seleccionadas" class="mb-3"></div>

    <button type="submit" class="btn btn-success">Filtrar</button>
</form>
{% endif %}

<hr>
<h4>Resultados Filtrados</h4>
<div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
    <table class="table table-striped table-hover" id="tablaResultados">
        <thead>
            {% if columnas %}
            <tr>
                {% for c in columnas %}
                <th>{{ c }}</th>
                {% endfor %}
            </tr>
            {% endif %}
        </thead>
        <tbody>
            {% if resultados %}
            {% for row in resultados %}
            <tr>
                {% for c in columnas %}
                <td>{{ row[c] or '' }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
            {% endif %}
        </tbody>
    </table>
</div>

{% if excel_filename %}
  <a id="descargarExcel" class="btn btn-info" href="{{ url_for('descargar_filtrados', filename=excel_filename) }}">Descargar Excel</a>
{% endif %}

<hr>
<h4>Estadísticas</h4>
<pre id="estadisticas">{{ estadisticas | tojson(indent=2) if estadisticas else '' }}</pre>

<script>
const preguntasPorTipo = {{ preguntas_por_tipo | tojson }};
const preguntasCompletas = {{ preguntas_completas | tojson }};

const checkboxContainer = document.getElementById('checkboxTipos');
const contenedorPreguntas = document.getElementById('preguntas_seleccionadas');
const errorSeleccion = document.getElementById('errorSeleccion');

function actualizarPreguntas() {
    const checkedBoxes = [...checkboxContainer.querySelectorAll('input[type=checkbox]:checked')];
    const seleccionados = checkedBoxes.map(chk => chk.value);
    let preguntasAMostrar = [];

    seleccionados.forEach(tipo => {
        if (preguntasPorTipo[tipo]) {
            preguntasAMostrar = preguntasAMostrar.concat(preguntasPorTipo[tipo]);
        }
    });

    preguntasAMostrar = [...new Set(preguntasAMostrar)];

    if (preguntasAMostrar.length > 0) {
    let html = '<label>Preguntas asociadas:</label><ul class="list-group">';
    preguntasAMostrar.forEach((p, index) => {
        const textoPregunta = preguntasCompletas[p] || p;
        html += `<li class="list-group-item"><strong>P${index + 1}:</strong> ${textoPregunta}</li>`;
    });
    html += '</ul>';
    contenedorPreguntas.innerHTML = html;
} else {
    contenedorPreguntas.innerHTML = '';
}

}

function validarSeleccion() {
    const checkedCount = checkboxContainer.querySelectorAll('input[type=checkbox]:checked').length;
    if (checkedCount < 2 || checkedCount > 4) {
        errorSeleccion.style.display = 'block';
        return false;
    } else {
        errorSeleccion.style.display = 'none';
        return true;
    }
}

checkboxContainer.addEventListener('change', () => {
    actualizarPreguntas();
    validarSeleccion();
});

document.getElementById("formFiltros").addEventListener("submit", function(e) {
    e.preventDefault();

    if (!validarSeleccion()) return;

    const formData = new FormData(this);

    fetch("{{ url_for('analisis_consumidores') }}", {
        method: "POST",
        body: formData,
        headers: {"X-Requested-With": "XMLHttpRequest"}
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }

        // Actualizar tabla
        const thead = document.querySelector("#tablaResultados thead");
        const tbody = document.querySelector("#tablaResultados tbody");
        thead.innerHTML = "";
        tbody.innerHTML = "";

        if (data.columnas) {
            let headerRow = "<tr>" + data.columnas.map(c => `<th scope='col'>${c}</th>`).join("") + "</tr>";
            thead.innerHTML = headerRow;
        }

        data.resultados.forEach(row => {
            let tr = "<tr>";
            data.columnas.forEach(c => {
                tr += `<td>${row[c] ?? ""}</td>`;
            });
            tr += "</tr>";
            tbody.innerHTML += tr;
        });

        // Estadísticas
        document.getElementById("estadisticas").textContent = JSON.stringify(data.estadisticas, null, 2);

        // Botón descargar Excel
        if (data.excel_filename) {
            const btn = document.getElementById("descargarExcel");
            btn.href = `/descargar/${data.excel_filename}`;
            btn.style.display = "inline-block";
        }
    });
});
</script>

<hr>
<h4>Gráficas</h4>
<div style="max-width: 600px; margin-bottom: 40px;">
    <canvas id="graficaPromedios"></canvas>
</div>
<div style="max-width: 400px;">
    <canvas id="graficaSexo"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function dibujarGraficaPromedios(promedios) {
    const ctx = document.getElementById('graficaPromedios').getContext('2d');
    const etiquetas = Object.keys(promedios);
    const valores = Object.values(promedios);

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: etiquetas,
            datasets: [{
                label: 'Promedio por pregunta',
                data: valores,
                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true, max: 5 }
            },
            plugins: {
                legend: { display: true }
            }
        }
    });
}

function dibujarGraficaSexo(data) {
    const ctx = document.getElementById('graficaSexo').getContext('2d');
    
    let conteo = {};
    data.forEach(row => {
        const sexo = row['Sexo'] || 'Desconocido';
        conteo[sexo] = (conteo[sexo] || 0) + 1;
    });

    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(conteo),
            datasets: [{
                label: 'Distribución por Sexo',
                data: Object.values(conteo),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)'
                ],
                borderColor: '#fff',
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

const estadisticas = {{ estadisticas | tojson }};
const resultados = {{ resultados | tojson }};

if (estadisticas && estadisticas.promedios) {
    dibujarGraficaPromedios(estadisticas.promedios);
}
if (resultados) {
    dibujarGraficaSexo(resultados);
}
</script>

<hr>
<div class="d-flex justify-content-end">
    <a href="{{ url_for('predecir') }}" class="btn btn-warning">Ir a Predecir</a>
</div>

{% endblock %}
